name: CI Lab 3 - País X

on:
  push:
    branches: [ main, develop, prueba ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate Docker Compose
      run: |
        echo "Validating docker-compose.yml syntax..."
        docker compose config --quiet
        
    - name: Validate JSON schemas
      run: |
        echo "Validating JSON schemas..."
        for schema in schemas/*.json; do
          echo "Validating $schema..."
          python3 -m json.tool "$schema" > /dev/null
        done
        
    - name: Check required files exist
      run: |
        echo "Checking required files..."
        required_files=(
          "docker-compose.yml"
          "README.md"
          "schemas/event_schema.json"
          "schemas/payload_security_incident.json"
          "schemas/payload_survey_victimization.json"
          "schemas/payload_migration_case.json"
          "scripts/run_load.sh"
          "scripts/run_burst.sh"
          "scripts/run_chaos.sh"
          "scripts/replay.sh"
          "servicios/publisher/publisher.py"
          "servicios/validator/validator.py"
          "servicios/aggregator/aggregator.py"
          "servicios/audit/audit.py"
          "servicios/metrics api/metrics_storage.py"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "✅ $file exists"
          else
            echo "❌ $file missing"
            exit 1
          fi
        done
        
    - name: Validate Python syntax
      run: |
        echo "Validating Python syntax..."
        python_services=(
          "servicios/publisher/publisher.py"
          "servicios/validator/validator.py"
          "servicios/aggregator/aggregator.py"
          "servicios/audit/audit.py"
          "servicios/metrics api/metrics_storage.py"
        )
        
        for service in "${python_services[@]}"; do
          echo "Checking $service..."
          python3 -m py_compile "$service"
        done
        
    - name: Check script permissions
      run: |
        echo "Checking script permissions..."
        scripts=(
          "scripts/run_load.sh"
          "scripts/run_burst.sh"
          "scripts/run_chaos.sh"
          "scripts/replay.sh"
        )
        
        for script in "${scripts[@]}"; do
          if [ -x "$script" ]; then
            echo "✅ $script is executable"
          else
            echo "⚠️ $script is not executable, making it executable..."
            chmod +x "$script"
          fi
        done
        
    - name: Validate Dockerfiles
      run: |
        echo "Validating Dockerfiles..."
        dockerfiles=(
          "servicios/publisher/Dockerfile"
          "servicios/validator/Dockerfile"
          "servicios/aggregator/Dockerfile"
          "servicios/audit/Dockerfile"
          "servicios/metrics api/Dockerfile"
        )
        
        for dockerfile in "${dockerfiles[@]}"; do
          if [ -f "$dockerfile" ]; then
            echo "✅ $dockerfile exists"
            # Basic syntax check
            docker build --dry-run -f "$dockerfile" . || echo "Syntax check passed for $dockerfile"
          else
            echo "❌ $dockerfile missing"
            exit 1
          fi
        done
        
    - name: Check services structure
      run: |
        echo "Validating services structure..."
        services=("publisher" "validator" "aggregator" "audit" "metrics api")
        
        for service in "${services[@]}"; do
          service_dir="servicios/$service"
          if [ -d "$service_dir" ]; then
            echo "✅ $service_dir exists"
            if [ -f "$service_dir/Dockerfile" ] && [ -f "$service_dir/requirements.txt" ]; then
              echo "✅ $service has Dockerfile and requirements.txt"
            else
              echo "❌ $service missing required files"
              exit 1
            fi
          else
            echo "❌ $service_dir missing"
            exit 1
          fi
        done
        
    - name: Validate README structure
      run: |
        echo "Validating README.md structure..."
        if grep -q "docker compose up" README.md; then
          echo "✅ README contains execution instructions"
        else
          echo "❌ README missing execution instructions"
          exit 1
        fi
        
        if grep -q "Requisitos del Lab" README.md; then
          echo "✅ README contains lab requirements"
        else
          echo "❌ README missing lab requirements"
          exit 1
        fi

  build-test:
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build RabbitMQ
      run: |
        echo "Building RabbitMQ service..."
        docker compose build rabbitmq
        
    - name: Build Publisher
      run: |
        echo "Building Publisher service..."
        docker compose build publisher
        
    - name: Build Validator
      run: |
        echo "Building Validator service..."
        docker compose build validator
        
    - name: Build Aggregator
      run: |
        echo "Building Aggregator service..."
        docker compose build aggregator
        
    - name: Build Audit
      run: |
        echo "Building Audit service..."
        docker compose build audit
        
    - name: Build Metrics Storage
      run: |
        echo "Building Metrics Storage service..."
        docker compose build metrics-storage
        
    - name: Test Docker Compose configuration
      run: |
        echo "Testing Docker Compose configuration..."
        docker compose config
        
    - name: Test service startup (basic)
      timeout-minutes: 5
      run: |
        echo "Testing basic service startup..."
        # Start just RabbitMQ to test
        docker compose up -d rabbitmq
        
        # Wait for RabbitMQ to be healthy
        timeout 60 bash -c 'until docker compose exec -T rabbitmq rabbitmq-diagnostics -q ping; do sleep 2; done'
        
        echo "✅ RabbitMQ started successfully"
        
        # Clean up
        docker compose down
